import{L as e,d as s,r as a,q as o,h as l,j as t,o as i,c as u,w as n,e as r,F as c,f as d,n as f,a as m,b as p,t as v,p as h,u as y,z as _,k as g,i as w,g as b,ad as k,A as C,H as z,ae as T}from"./index-5b39df8e.js";import{D as x,K as F,B as L,o as D,b as P,j as I,a as S}from"./page-wraper.5f136bdc.js";import{u as U}from"./useTranslate.58e1bf0a.js";const j=S(s({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{customClass:{default:""},customEvokeClass:{default:""},customPreviewClass:{default:""},multiple:{type:Boolean,default:!1},accept:{default:"image"},sizeType:{default:()=>["original","compressed"]},sourceType:{default:()=>["album","camera"]},header:{default:()=>({})},name:{default:"file"},formData:{default:()=>({})},action:null,fileList:{default:()=>[]},statusKey:{default:"status"},maxSize:{default:Number.MAX_VALUE},limit:null,showLimitNum:{type:Boolean,default:!0},disabled:{type:Boolean,default:!1},useDefaultSlot:{type:Boolean,default:!1},loadingType:{default:"ring"},loadingColor:{default:"#ffffff"},loadingSize:{default:"24px"},beforePreview:null,onPreviewFail:null,beforeRemove:null,beforeUpload:null,beforeChoose:null,buildFormData:null},emits:["fail","change","success","progress","oversize","chooseerror","remove"],setup(s,{emit:S}){const j=s,{translate:B}=U("upload"),E=a([]);function K(e,s,a){const{statusKey:o}=j,l=E.value.findIndex((e=>e.uid===s.uid));l>-1&&(E.value[l][o]="fail",E.value[l].error=e.message,E.value[l].response=e,S("fail",{error:e,file:s,formData:a}))}function A(e,s){const{action:a,name:o,header:l={},accept:t}=j;T({url:a,header:l,name:o,fileName:o,fileType:t,formData:s,filePath:e.url,success(a){200===a.statusCode?function(e,s,a){const{statusKey:o}=j,l=E.value.findIndex((e=>e.uid===s.uid));l>-1&&(E.value[l][o]="success",E.value[l].response=e.data,S("change",{fileList:E.value}),S("success",{file:s,fileList:E.value,formData:a}))}(a,e,s):K(a,e,s)},fail(a){K(a,e,s)}}).onProgressUpdate((s=>{!function(e,s){const a=E.value.findIndex((e=>e.uid===s.uid));a>-1&&(E.value[a].percent=e.progress,S("progress",{response:e,file:s}))}(s,e)}))}function N(){const{multiple:s,maxSize:a,accept:o,sizeType:l,limit:t,sourceType:i,beforeUpload:u}=j;"image"===o&&function({multiple:s,sizeType:a,sourceType:o,maxCount:l}){return new Promise(((t,i)=>{e({count:s?Math.min(l,9):1,sizeType:a,sourceType:o,success:t,fail:i})}))}({multiple:s,sizeType:l,sourceType:i,maxCount:t?t-E.value.length:9}).then((e=>{let o=null;o=Array.prototype.slice.call(e.tempFiles),s||(o=o.slice(0,1));const l=e=>{e.forEach((async e=>{var s;I(e.size)||(e.size=await(s=e.path,new Promise(((e,a)=>{z({src:s,success:s=>{e(s.height*s.width)},fail:()=>{a(0)}})})))),e.size<=a?function(e){const s={uid:F.id++,name:e.name||"",status:"loading",size:e.size,url:e.path,action:j.action,percent:0};E.value.push(s);const{buildFormData:a,formData:o={}}=j;a?a({file:s,formData:o,resolve:e=>{e&&A(s,e)}}):A(s,o)}(e):S("oversize",{file:e})}))};u?2===u.length?u(o,(e=>{e&&l(o)})):u({files:o,fileList:E.value,resolve:e=>{e&&l(o)}}):l(o)})).catch((e=>{S("chooseerror",{error:e})}))}function R(){if(j.disabled)return;const{beforeChoose:e}=j;e?2===e.length?e(E.value,(e=>{e&&N()})):e({fileList:E.value,resolve:e=>{e&&N()}}):N()}function H(e,s){E.value.splice(E.value.findIndex((s=>s.uid===e.uid)),1),S("change",{fileList:E.value}),S("remove",{file:e})}function M(e,s){const{onPreviewFail:a}=j;k({urls:s,current:s[e],fail(){a?2===a.length?a(e,s):a({index:e,imgList:s}):C({title:"预览图片失败",icon:"none"})}})}return o((()=>j.fileList),(e=>{const{statusKey:s}=j;if(x(e,E.value))return;const a=e.map((e=>(e.uid=F.id++,e[s]=e[s]||"success",e.size=e.size||"",e.action=j.action||"",e.response=e.response||"",e)));E.value=a}),{deep:!0,immediate:!0}),o((()=>j.limit),(e=>{e&&e<E.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),o((()=>j.beforePreview),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),o((()=>j.onPreviewFail),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),o((()=>j.beforeRemove),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),o((()=>j.beforeUpload),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),o((()=>j.beforeChoose),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),o((()=>j.buildFormData),(e=>{e&&"function"!==L(e)&&"asyncfunction"!==L(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0}),(e,a)=>{const o=g,k=w,C=l(t("wd-loading"),D),z=b,T=l(t("wd-icon"),P);return i(),u(k,{class:f(["wd-upload",s.customClass])},{default:n((()=>[(i(!0),r(c,null,d(E.value,((e,a)=>(i(),u(k,{class:f(["wd-upload__preview",s.customPreviewClass]),key:a},{default:n((()=>[m(k,{class:"wd-upload__status-content"},{default:n((()=>[m(o,{src:e.url,mode:"aspectFit",class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:s}=j,a=E.value.map((e=>e.url));s?2===s.length?s({index:e,lists:a},(s=>{s&&M(e,a)})):s({index:e,imgList:a,resolve:s=>{s&&M(e,a)}}):M(e,a)}(a)},null,8,["src","onClick"])])),_:2},1024),"success"!==e.status?(i(),u(k,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:n((()=>["loading"===e.status?(i(),u(k,{key:0,class:"wd-upload__status-content"},{default:n((()=>[m(C,{size:24,color:s.loadingColor},null,8,["color"]),m(z,{class:"wd-upload__progress-txt"},{default:n((()=>[p(v(e.percent)+"%",1)])),_:2},1024)])),_:2},1024)):h("",!0),"fail"===e.status?(i(),u(k,{key:1,class:"wd-upload__status-content"},{default:n((()=>[m(T,{name:"close-outline","custom-class":"wd-upload__icon"}),m(z,{class:"wd-upload__progress-txt"},{default:n((()=>[p(v(e.error||y(B)("error")),1)])),_:2},1024)])),_:2},1024)):h("",!0)])),_:2},1024)):h("",!0),"loading"===e.status||s.disabled?h("",!0):(i(),u(T,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:s}=j,a=parseInt(e),o=E.value[a];s?3===s.length?s(o,E.value,(e=>{e&&H(o)})):s({file:o,index:a,fileList:E.value,resolve:e=>{e&&H(o)}}):H(o)}(a)},null,8,["onClick"]))])),_:2},1032,["class"])))),128)),m(k,{onClick:R},{default:n((()=>[s.useDefaultSlot?_(e.$slots,"default",{key:0},void 0,!0):h("",!0),s.useDefaultSlot||s.limit&&!(E.value.length<s.limit)?h("",!0):(i(),u(k,{key:1,class:f(["wd-upload__evoke",s.disabled?"is-disabled":"",s.customEvokeClass])},{default:n((()=>[m(T,{class:"wd-upload__evoke-icon",name:"fill-camera"}),s.limit&&s.showLimitNum?(i(),u(k,{key:0,class:"wd-upload__evoke-num"},{default:n((()=>[p("（"+v(E.value.length)+"/"+v(s.limit)+"）",1)])),_:1})):h("",!0)])),_:1},8,["class"]))])),_:3})])),_:3},8,["class"])}}}),[["__scopeId","data-v-334d7e8b"]]);export{j as _};
